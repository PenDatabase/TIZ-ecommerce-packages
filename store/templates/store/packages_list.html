{% extends 'store/base.html' %}

{% block topjs %}
  <script>
    function searchPackages() {
      const searchInput = document.getElementById('search-bar').value.toLowerCase();
      const packageCards = document.querySelectorAll('.package-card');
      let anyVisible = false;

      packageCards.forEach(card => {
        const packageName = card.querySelector('h3').textContent.toLowerCase();

        if (packageName.includes(searchInput)) {
          card.style.display = 'block';
          anyVisible = true;
        } else {
          card.style.display = 'none';
        }
      });

      // Show/hide the "Press Enter for more results" message
      const enterMessage = document.getElementById('enter-message');
      enterMessage.style.display = anyVisible ? 'none' : 'flex';
      enterMessage.classList.toggle('fade-in', !anyVisible);
    }
  </script>

  <style>
    .fade-in {
      opacity: 0;
      animation: fadeIn 0.4s ease-in-out forwards;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
{% endblock topjs %}

{% block body %}
  <!-- Packages Section -->
  <section class="py-24 mt-12 bg-gray-100">
    <div class="container mx-auto px-6">
      <div class="flex justify-between items-center mb-8">
        <h2 class="text-3xl font-bold">Available Packages</h2>
        <div>
          <form action="{% url 'store:package-listing' %}" method="get" class="relative">
            <input 
              id="search-bar" 
              name="search" 
              type="text" 
              placeholder="Search packages..." 
              class="px-4 py-2 rounded-lg border border-gray-300 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400 pr-10"
              oninput="searchPackages()"
            >
            <button type="submit">
              <svg xmlns="http://www.w3.org/2000/svg" class="absolute right-3 top-3 h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M8 3a5 5 0 1 1 3.742 8.242l3.15 3.15a1 1 0 0 1-1.415 1.415l-3.15-3.15A5 5 0 0 1 8 3zm0 2a3 3 0 1 0 2.121 5.121A3 3 0 0 0 8 5z" clip-rule="evenodd"/>
              </svg>
            </button>
          </form>
        </div>
      </div>

      <!-- Message when no results are found -->
      <div id="enter-message" class="hidden flex flex-col justify-center items-center h-64 text-center fade-in">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-gray-400 mb-4" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M8 3a5 5 0 1 1 3.742 8.242l3.15 3.15a1 1 0 0 1-1.415 1.415l-3.15-3.15A5 5 0 0 1 8 3zm0 2a3 3 0 1 0 2.121 5.121A3 3 0 0 0 8 5z" clip-rule="evenodd"/>
        </svg>
        <p class="text-2xl font-semibold text-gray-600">
          No packages found for this search.<br> 
          <span class="text-blue-600">Hit <b>Enter</b> for more detailed search results.</span>
        </p>
      </div>

      <div id="package-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
        {% for package in packages %}
            <div class="package-card bg-white rounded-lg shadow-lg hover-bounce fade-in">
                <img src="" alt="Fresher's Starter Pack" class="w-full h-48 object-cover">
                <div class="p-6">
                    <a href="{% url 'store:package-detail' package.pk %}">
                        <h3 class="text-lg underline hover:text-blue-600 font-semibold mb-2">{{ package.name }}</h3>
                    </a>
                    <p class="text-gray-600 mb-1">{{ package.description }}</p>
                    <p class="text-sm text-green-500 font-medium mb-4">Best for: {{ package.use_case }}</p>
                    <span class="text-blue-600 font-bold text-lg">&#8358;{{ package.price }}</span>
                    <div class="flex justify-between items-center mt-4">
                      <button class="px-4 py-2 bg-blue-600 text-white font-semibold rounded hover:bg-blue-500" onclick="addToCart(`{{ package.pk }}`)">Add to Cart</button>
                      <a href="{% url 'store:package-detail' package.pk %}" class="text-blue-600 hover:underline">View Details</a>
                    </div>
                </div>
            </div>
        {% endfor %}
      </div>
    </div>
  </section>

  <form method="post">
    {% csrf_token %}
  </form>

  <!-- Notification Container -->
  <div id="cart-notification" class="fixed top-20 border-[2px] border-black/50 right-5 bg-white text-black px-4 py-2 rounded-lg shadow-lg opacity-0 transition-opacity duration-500 ease-in-out">
    âœ… Package added to cart!
  </div>


  <script>
    function showNotification() {
  const notification = document.getElementById("cart-notification");
  notification.style.display = "block";  // Ensure it's visible
  notification.classList.remove("opacity-0");
  notification.classList.add("opacity-100");

  setTimeout(() => {
    notification.classList.remove("opacity-100");
    notification.classList.add("opacity-0");

    setTimeout(() => {
      notification.style.display = "none"; // Hide it after fade-out
    }, 500);
  }, 3000);
}

    function getCSRFToken(){
      return document.querySelector('[name=csrfmiddlewaretoken]').value
    }

    async function addToCart(package_pk) {
      try {
        const response = await fetch(`${window.location.origin}/cart/add/${package_pk}`, {
          method: "POST",
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': getCSRFToken(),
          }
        });

        if (!response.ok){
          throw new Error(`Status: ${response.status}`)
        }

        const data = await response.json();

        if (data.success) {
          showNotification();
        } else if (data.redirect) {
          window.location.href = data.redirect;
        } else {
          console.error("Error:", data.detail);
        }
      } catch (error) {
        console.error("Network error:", error);
      }
    }

  </script>
{% endblock body %}
